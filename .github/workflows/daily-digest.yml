name: Daily AI Tech Digest

on:
  schedule:
    # KST ì˜¤ì „ 8ì‹œ = UTC 23ì‹œ (ì „ë‚ )
    - cron: '0 23 * * *'
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      debug_enabled:
        type: boolean
        description: 'Enable debug mode'
        required: false
        default: false

env:
  PYTHON_VERSION: '3.11'
  TZ: 'Asia/Seoul'

jobs:
  generate-digest:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run digest generator
        id: digest
        env:
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_REFRESH_TOKEN: ${{ secrets.KAKAO_REFRESH_TOKEN }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
          TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
        run: |
          cd ${{ github.workspace }}
          python src/main.py
        continue-on-error: true

      - name: Check result
        if: steps.digest.outcome == 'failure'
        run: |
          echo "::warning::Digest generation failed, but continuing..."

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: digest-output-${{ github.run_number }}
          path: output/
          retention-days: 30
          if-no-files-found: warn

      - name: Summary
        if: always()
        run: |
          echo "## ğŸ¤– AI Tech Digest ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ì‹œê°„**: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          echo "- **ìƒíƒœ**: ${{ steps.digest.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "output" ]; then
            echo "### ğŸ“ ì¶œë ¥ íŒŒì¼" >> $GITHUB_STEP_SUMMARY
            find output -type f -name "*.json" | while read f; do
              echo "- \`$f\`" >> $GITHUB_STEP_SUMMARY
            done
          fi

  # ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (ì„ íƒì )
  notify-on-failure:
    needs: generate-digest
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ AI Tech Digest ì‹¤í–‰ ì‹¤íŒ¨ - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨ ì•Œë¦¼

            - **Run ID**: ${{ github.run_id }}
            - **Run Number**: ${{ github.run_number }}
            - **ì‹œê°„**: ${new Date().toISOString()}

            [ì›Œí¬í”Œë¡œìš° ë¡œê·¸ í™•ì¸](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            // ê¸°ì¡´ ì´ìŠˆ í™•ì¸
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'workflow-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['workflow-failure', 'automated']
              });
            }
